<?php


// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
$formdata = $oF->exportValues();


// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
$AUTO_LOGIN = false;


// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
$oTable = $AUTH->getStorage()->getDbTable();


// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
$oTable->toObject($formdata, true, array());

$oTable->pwd       = md5($formdata["pwd1"]);

$oTable->fk_status = $AUTO_LOGIN? STATUS_ONLINE : STATUS_DRAFT;
$oTable->hashval   = \Cnx\Hash::generate(10);




// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
if ($oTable->save()) {



    // +----------------------------------------------------------------------+
    // |                                                                      |
    // +----------------------------------------------------------------------+
    $maildata = $oTable->toMaildata();



    // +----------------------------------------------------------------------+
    // | User - Mail                                                          |
    // +----------------------------------------------------------------------+
    try {
        \Cnx\Db\Table::factory($oTable->getDb(), TB_MAIL)->sendmail("user.registration", $oTable->email, $maildata);
    } catch (\Exception $oEx) {
        //\Cnx\Debugger::err($oEx, __FILE__, __LINE__);
    }


    // +----------------------------------------------------------------------+
    // | Admin - Mail                                                         |
    // +----------------------------------------------------------------------+
    try {
        \Cnx\Db\Table::factory($oTable->getDb(), TB_MAIL)->sendmail("user.registration.admin", null, $maildata);
    } catch (\Exception $oEx) {
        //\Cnx\Debugger::err($oEx, __FILE__, __LINE__);
    }



    // +----------------------------------------------------------------------+
    // | Auto - Login                                                         |
    // +----------------------------------------------------------------------+
    if ($AUTO_LOGIN) {

        $AUTH->setAuth($oTable->usr);
        foreach ($oTable as $key => $value) {
            $AUTH->setAuthData($key, $value, $overwrite = true);
        }

        $AUTH->getStorage()->getDbTable()->onLogin($oTable->usr, $AUTH);
    }


}


// +----------------------------------------------------------------------+
// |                                                                      |
// +----------------------------------------------------------------------+
$oF->freeze();

